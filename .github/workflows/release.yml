name: Release Build

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        os: [windows-latest, ubuntu-latest, macos-latest]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          # Install core dependencies
          pip install PySide6 mutagen Pillow requests musicbrainzngs pytest
          # Install optional dependencies that may fail on some platforms
          pip install koroman || true
        shell: bash

      - name: Verify dependencies installation
        run: |
          python -c "import sys; print(f'Python version: {sys.version}')"
          pip list
        shell: bash

      - name: Build with PyInstaller (Windows)
        if: runner.os == 'Windows'
        run: |
          pyinstaller --onefile --windowed --name tagqt --collect-all PySide6 --collect-all mutagen --collect-all Pillow main.py
          dir dist
        shell: cmd

      - name: Verify Windows build
        if: runner.os == 'Windows'
        run: |
          if not exist "dist\tagqt.exe" (
            echo Build failed: tagqt.exe not found
            exit /b 1
          )
          echo Build successful: tagqt.exe created
        shell: cmd

      - name: Build with PyInstaller (Linux)
        if: runner.os == 'Linux'
        run: |
          pyinstaller --onefile --windowed --name tagqt --collect-all PySide6 --collect-all mutagen --collect-all Pillow main.py
          chmod +x dist/tagqt
          ls -lh dist/

      - name: Create AppImage (Linux)
        if: runner.os == 'Linux'
        run: |
          # Install ImageMagick for icon creation
          sudo apt-get update && sudo apt-get install -y imagemagick
          
          # Download linuxdeploy
          wget -q https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          chmod +x linuxdeploy*.AppImage
          
          # Create AppDir structure
          mkdir -p AppDir/usr/bin
          mkdir -p AppDir/usr/share/applications
          mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps
          
          # Copy binary
          cp dist/tagqt AppDir/usr/bin/
          
          # Create desktop entry (no leading whitespace - required for AppImage)
          printf '%s\n' '[Desktop Entry]' 'Type=Application' 'Name=TagQt' 'Exec=tagqt' 'Icon=tagqt' 'Categories=Audio;AudioVideo;' > AppDir/usr/share/applications/tagqt.desktop
          
          # Create a simple icon (placeholder)
          echo "Creating placeholder icon"
          convert -size 256x256 xc:blue AppDir/usr/share/icons/hicolor/256x256/apps/tagqt.png
          
          # Build AppImage - no need for qt plugin since PyInstaller bundles Qt
          export OUTPUT=tagqt.AppImage
          ./linuxdeploy-x86_64.AppImage --appdir AppDir --output appimage
          
          # Move to dist folder
          mv tagqt*.AppImage dist/tagqt.AppImage
          chmod +x dist/tagqt.AppImage
          ls -lh dist/

      - name: Verify Linux build
        if: runner.os == 'Linux'
        run: |
          if [ ! -f "dist/tagqt.AppImage" ]; then
            echo "Build failed: tagqt.AppImage not found"
            exit 1
          fi
          echo "Build successful: tagqt.AppImage created"

      - name: Build with PyInstaller (macOS)
        if: runner.os == 'macOS'
        run: |
          pyinstaller --onefile --windowed --name tagqt --collect-all PySide6 --collect-all mutagen --collect-all Pillow main.py
          ls -lh dist/

      - name: Verify macOS build
        if: runner.os == 'macOS'
        run: |
          if [ ! -d "dist/tagqt.app" ] && [ ! -f "dist/tagqt" ]; then
            echo "Build failed: tagqt application not found"
            exit 1
          fi
          echo "Build successful: tagqt application created"

      - name: Prepare artifacts (Windows)
        if: runner.os == 'Windows'
        run: |
          copy dist\tagqt.exe tagqt-windows.exe
        shell: cmd

      - name: Prepare artifacts (Linux)
        if: runner.os == 'Linux'
        run: |
          cp dist/tagqt.AppImage tagqt-linux.AppImage

      - name: Prepare artifacts (macOS)
        if: runner.os == 'macOS'
        run: |
          # Create a zip of the .app bundle if it exists, otherwise use the binary
          if [ -d "dist/tagqt.app" ]; then
            cd dist && zip -r ../tagqt-macos.zip tagqt.app && cd ..
            echo "APP_BUNDLE=true" >> $GITHUB_ENV
          else
            cp dist/tagqt tagqt-macos
            echo "APP_BUNDLE=false" >> $GITHUB_ENV
          fi

      - name: Upload artifacts (Windows)
        if: runner.os == 'Windows'
        uses: actions/upload-artifact@v4
        with:
          name: tagqt-windows
          path: tagqt-windows.exe

      - name: Upload artifacts (Linux)
        if: runner.os == 'Linux'
        uses: actions/upload-artifact@v4
        with:
          name: tagqt-linux
          path: tagqt-linux.AppImage

      - name: Upload artifacts (macOS - App Bundle)
        if: ${{ runner.os == 'macOS' && env.APP_BUNDLE == 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: tagqt-macos
          path: tagqt-macos.zip

      - name: Upload artifacts (macOS - Binary)
        if: ${{ runner.os == 'macOS' && env.APP_BUNDLE == 'false' }}
        uses: actions/upload-artifact@v4
        with:
          name: tagqt-macos
          path: tagqt-macos

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure of downloaded artifacts
        run: |
          ls -R artifacts/

      - name: Prepare release assets
        run: |
          mkdir -p release_assets
          find artifacts -type f -exec cp {} release_assets/ \;
          ls -lh release_assets/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: release_assets/*
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
